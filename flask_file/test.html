<head>
  <link rel="stylesheet" href="{{ url_for('static', filename='range-slider.css') }}?version=1.0">
  <!-- jquery -->
  <script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='echarts.min.js') }}"></script>
  <!-- local src -->
  <script src="{{ url_for('static', filename='range-slider.js') }}"></script>
</head>

<body>
  <div class="info" >
    <h3 style="float:left">splits iv: <span id="iv"></span> </h3>
    <h4 style="float:right">xtype: <span id="xtype"></span> min: <span id="min"></span> max: <span id="max"></span> step: <span
        id="step"></span></h4>
  </div>
  <div>
    <br><br>
  </div>
  <div class="slider"></div>

  <h4>splits: <span id="splits"></span></h4>
  <!-- <h3>chart</h3> -->
  <div id="chart1" style="width: 600px;height:400px;"></div>

  <script>
    function getUrlParam(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
      var r = window.location.search.substr(1).match(reg);
      if (r != null) return decodeURI(r[2]); return null;
    }

    // function getPrecision(v){
    //   let _v = Number(v);
    //   let s = Number(v).toString();
    
    //   if (s.indexOf('.') === -1){
    //     let i=1;
    //     while(_v % i === 0){
    //         i *= 10;
    //     }
    //     return i / 10;
    //   }else{

    //     let res = "0.";
    //     let i = 0;
    //     while(i<s.length - s.indexOf('.') - 2){
    //       res = res + "0";
    //       i++;
    //     }
    //     return Number(res + "1");
    //   }     
    // }


    inf = Infinity;

    var data = {{ data }};
    var slider_xtype = getUrlParam('xtype') || 'linear';
    var slider_step = Number(getUrlParam('step') || 0.01);//Math.min(...data.info.splits.map(v => getPrecision(v))));
    var slider_min = Number(getUrlParam('min') || data.info.min);
    var slider_max = Number(getUrlParam('max') || data.info.max);

    let slider = new RangeSlider('.slider', {
      "values": data.info.splits,
      "xtype": slider_xtype,
      "step": slider_step,
      "min": slider_min,
      "max": slider_max
    });
    console.log(data);


    $("#xtype").text(slider_xtype);
    $("#min").text(slider_min.toFixed(4));
    $("#max").text(slider_max.toFixed(4));
    $("#step").text(slider_step);

    slider.onChange(function () {
      if (slider.getValues().sort().toString() === data.info.splits.sort().toString()) {
        console.log("equal");
      } else {
        console.log("not equal");
        new_splits = slider.getValues();
        data.info.splits = new_splits;
        console.log(new_splits);
        $.ajax({
          url: "/test?var=" + data.info.var,
          type: "POST",
          data: JSON.stringify(new_splits),
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          success: function (rsp) {
            console.log("update data success");
            update_data(rsp);
          },
          error: function (message) {
            console.log("update data error");
            console.log(message);
          }
        });
      }

    });


    function update_data(rsp) {
      data = rsp;
      $("#iv").text(data.info.iv.toFixed(4));
      $("#splits").text(data.info.splits.reduce((a, b) => a + ', ' + b));
      chart1.setOption({
        xAxis: [
          {
            data: data.df.map(function (item) { return item.interval }),
          }
        ],
        series: [
          {
            data: data.df.map(function (item) { return item.nobs })
          },
          {
            data: data.df.map(function (item) { return item.bad_rate })
          }
        ]
      });
    }

    function valueInInterval(interval,value){
      // interval: "[0.0, 0.1)" or "[0.0, 0.1]" or "(0.0, 0.1)" or "(0.0, 0.1]"
      return interval.replace(/[\[\]\(\),]/g, " ").split(" ").filter(v => v !== "").map(Number).includes(value);
    }


    function highlight_bar(chart, value) {
      let barIndex = [];
      for (let i = 0; i < data.df.length; i++) {
        if (valueInInterval(data.df[i].interval,value)) {
          barIndex.push(i);
        }
      }
      // console.log(barIndex);
      chart.dispatchAction({
        type: 'highlight',
        seriesIndex: 0,
        dataIndex: barIndex
      });
    }

    function downplay_bar(chart) {
      chart.dispatchAction({
        type: 'downplay',
        seriesIndex: 0,
        // dataIndex: 0
      });
    }

    var chart1 = echarts.init(document.getElementById('chart1'));

    slider.mouseOverHandlers.push((index, value) => highlight_bar(chart1, value));
    slider.mouseOutHandlers.push((index, value) => downplay_bar(chart1));


    // echart
    option = {
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'cross',
          crossStyle: {
            color: '#999'
          }
        }
      },
      toolbox: {
        feature: {
          dataView: { show: true, readOnly: false },
          // magicType: { show: true, type: ['line', 'bar'] },
          // restore: { show: true },
          saveAsImage: { show: true }
        }
      },
      dataZoom: [
        {
          id: 'dataZoomX1',
          type: 'slider',
          xAxisIndex: 0,
          filterMode: 'none'
        },

        {
          id: 'dataZoomY1',
          type: 'slider',
          yAxisIndex: 0,
          left: 0,
          filterMode: 'none'
        },
        {
          id: 'dataZoomY2',
          type: 'slider',
          yAxisIndex: 1,
          filterMode: 'none'
        }
      ],

      legend: {
        data: ['Nobs', 'BadRate']
      },
      xAxis: [
        {
          type: 'category',
          // data: intervals,
          axisPointer: {
            type: 'shadow'
          }
        }
      ],
      yAxis: [
        {
          type: 'value',
          name: 'Nobs',
          min: 0,
          // // max: 250,
          // interval: 500,
          axisLabel: {
            formatter: '{value} '
          }
        },
        {
          type: 'value',
          name: 'BadRate',
          min: 0,
          // max: "100%",
          // interval: 5,
          axisLabel: {
            formatter: function (value) { return (value * 100).toFixed(1) + ' %' }
          }
        }
      ],
      series: [
        {
          name: 'Nobs',
          type: 'bar',
          tooltip: {
            valueFormatter: function (value) {
              return value + '(' + (value / data.info.total * 100).toFixed(1) + '%)';
            }
          },
          emphasis: {
            itemStyle: {
              color: '#73c0de'
            }
          }
          // data: nobs
        },
        {
          name: 'BadRate',
          type: 'line',
          yAxisIndex: 1,
          tooltip: {
            valueFormatter: function (value) {
              return (value * 100).toFixed(1) + ' %';
            }
          }
          // data: badrate
        }
      ]
    };

    chart1.setOption(option);
    update_data(data);

  </script>
</body>